import os
import pymysql
from textblob import TextBlob
from tqdm import tqdm
from pymysql.constants import CLIENT

host = os.environ.get("DB_HOST","investdata.c5cwsai4kiot.us-east-1.rds.amazonaws.com")
user = os.environ.get("DB_USER","admin")
password = os.environ.get("DB_PASSWORD","12345678")
database = os.environ.get("DB_NAME","your_database_name")

try:
    # Connect to the MySQL server
    connection = pymysql.connect(host=host, user=user, password=password, database=database,client_flag  = CLIENT.MULTI_STATEMENTS)
    cursor = connection.cursor()
    select_query = f"SELECT * FROM {'sns_comments'}"

    cursor.execute(select_query)
    table_data = cursor.fetchall()
    for i in tqdm(range(len(table_data)//100)):
        query = ""
        for row in table_data[100*i:100*(i+1)]:
            blob = TextBlob(row[11])
            sentiment = blob.sentiment.polarity
            query +=f"UPDATE sns_comments SET vadersentiment_pos={sentiment} WHERE CommentID={row[0]} ; "# need to rename column to textblobsentiment
        #print(query)
        cursor.execute(query)
        connection.commit()


        
except pymysql.Error as e:
    print(f"Error: {e}")

finally:
    if connection:
        connection.close()
